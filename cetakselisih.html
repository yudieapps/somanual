<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        .gradient-header {
            background: linear-gradient(90deg, #6a11cb, #2575fc);
            color: white;
            padding: 20px;
            text-align: center;
        }

        /* Untuk memastikan overlay bekerja baik */
        .table-responsive {
            position: relative;
            z-index: 1;
        }

        .logo-header {
            font-size: 2.5rem;
            margin-right: 15px;
        }

        .table-custom {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        }

        .table-custom thead {
            background: #6a11cb;
            color: white;
        }

        .status-radio {
            border: 2px solid #fff !important;
            box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.25);
        }

        .oh-input {
            width: 100px;
            text-align: center;
            border: 1px solid #ced4da;
        }

        .oh-input:focus {
            box-shadow: 0 0 0 3px rgba(106, 17, 203, 0.25);
        }

        .spinner-border {
    margin-right: 8px;
}

.btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
}

        @media (max-width: 576px) {

            .table td,
            .table th {
                padding: 0.8rem;
                font-size: 0.9rem;
            }
        }
    </style>
</head>

<body>
    <header class="gradient-header">
        <div class="d-flex align-items-center justify-content-center">
            <i class="bi bi-boxes logo-header"></i>
            <h1 class="mb-0">Inventory System</h1>
        </div>
        <div class="d-flex align-items-center justify-content-center">
            <h4>Cek Selisih</h4>
        </div>
        
    </header>

    <div class="container">
         
        <!-- Tabel Data -->
        <div class="table-responsive">
            <table class="table table-custom table-hover">
                <thead>
                    <tr>
                        <th><i class="bi bi-upc-scan"></i> PLU</th>
                        <th><i class="bi bi-card-text"></i> Deskripsi</th>
                        <th><i class="bi bi-box"></i> Total</th>
                        <th><i class="bi bi-clipboard2-plus"></i> Selisih</th>
                        <th><i class="bi bi-pencil"></i> Revisi</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Data akan dimasukkan di sini -->
                </tbody>
            </table>
        </div>


   <!-- Tombol Halaman Berikutnya -->
   <div class="d-flex justify-content-end mt-4 mb-4 g-4">
    <button id="nextPageButton" class="btn btn-primary btn-next">
        <i class="bi bi-arrow-right"></i> Lanjut
    </button>
    </div>
    </div>       


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>

        document.addEventListener('DOMContentLoaded', () => {
            const storedData = JSON.parse(localStorage.getItem('fetchedData')) || [];
            const tbody = document.getElementById('tableBody');

            // Fungsi validasi
            const safeNumber = (num) => Number(num) || 0;

            tbody.innerHTML = storedData
    .filter(item => {
        const qty = safeNumber(item.qty);
        const rapj = safeNumber(item.rapj);
        const oh = safeNumber(item.oh);
        const total = qty + rapj;
        const selisih = total - oh;
        return selisih !== 0; // Hanya ambil data dengan selisih != 0
    })
    .map(item => {
        // Kode mapping yang sama seperti sebelumnya
        const qty = safeNumber(item.qty);
        const oh = safeNumber(item.oh);
        const rapj = safeNumber(item.rapj);
        const total = qty + rapj;
        const selisih = total - oh;

        return `
            <tr>
                <td class="non-editable">${item.plu || '-'}</td>
                <td class="non-editable">${item.description || '-'}</td>
                <td class="non-editable text-center">${total.toLocaleString('id-ID')}</td>
                <td class="non-editable text-center ${selisih < 0 ? 'text-danger' : 'text-success'}">
                    ${selisih.toLocaleString('id-ID')}
                </td>
                <td>
                    <input type="number" 
                           class="form-control editable-input text-center" 
                           value="${safeNumber(item.revisiqty)}"
                           data-plu="${item.plu}"
                           data-total="${total}"
                           style="width: 100px">
                </td>
            </tr>`;
    }).join('');

            // Event listener untuk revisi
            document.querySelectorAll('.editable-input').forEach(input => {
                input.addEventListener('change', function () {
                    const plu = this.dataset.plu;
                    const revisiQty = safeNumber(this.value);
                    const total = safeNumber(this.dataset.total);

                    // Update hanya field revisiqty
                    const updatedData = storedData.map(item => {
                        if (item.plu === plu) {
                            return {
                                ...item,
                                revisiqty: revisiQty,
                                selisih_revisi: total - revisiQty
                            };
                        }
                        return item;
                    });

                    localStorage.setItem('fetchedData', JSON.stringify(updatedData));

                    // Update UI
                    const row = this.closest('tr');
                    const selisihCell = row.querySelector('td:nth-child(9)');
                    const newSelisih = total - revisiQty;

                    selisihCell.textContent = newSelisih.toLocaleString('id-ID');
                    selisihCell.className = `non-editable text-end ${newSelisih < 0 ? 'text-danger' : 'text-success'
                        }`;
                });
            });
        });

        document.getElementById('nextPageButton').addEventListener('click', async () => {
    const button = document.getElementById('nextPageButton');
    button.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Mengirim...';
    button.disabled = true;
    const storedData = JSON.parse(localStorage.getItem('fetchedData')) || [];
    
    try {
        const response = await fetch('https://script.google.com/macros/s/AKfycbzTLYv2Dsp8SD5SWXH1T6nyA3Z6uTpKXBMRfc7E_InDMuN-esSRenmanadZX7jUttPBnA/exec', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(storedData)
        });

        if (response.ok) {
            alert('Data berhasil dikirim ke Google Sheets!');
            window.location.href = 'halaman-berikutnya.html'; // Ganti dengan halaman tujuan
        } else {
            throw new Error('Gagal mengirim data');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Terjadi kesalahan saat mengirim data');
        button.innerHTML = '<i class="bi bi-arrow-right"></i> Lanjut';
        button.disabled = false;
    }
});

    </script>
</body>

</html>
